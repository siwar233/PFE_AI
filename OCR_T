from flask import Flask, render_template, request
from pdfminer.high_level import extract_text
import os
import psycopg2

app = Flask(__name__)

UPLOAD_FOLDER = 'uploads'
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# Ensure the upload folder exists
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

# Function to create PostgreSQL connection and cursor
def create_connection():
    conn = psycopg2.connect(
        host="your_host",
        database="your_database",
        user="your_username",
        password="your_password"
    )
    cursor = conn.cursor()
    return conn, cursor

# Function to insert experience record
def insert_experience(cursor, title, start_date, end_date, company):
    cursor.execute('''INSERT INTO "Experience" (Title, StartDate, EndDate, Company) VALUES (%s, %s, %s, %s)''',
                   (title, start_date, end_date, company))

@app.route('/')
def upload_form():
    return render_template('upload.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    if request.method == 'POST':
        if 'pdf_file' not in request.files:
            return 'No file part'
        pdf_file = request.files['pdf_file']
        if pdf_file.filename == '':
            return 'No selected file'
        if pdf_file:
            filename = pdf_file.filename
            filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
            pdf_file.save(filepath)
            text = extract_text(filepath)
            # Here you can implement your OCR code to extract the desired information from the PDF
            # For simplicity, let's just print the extracted text
            print(text)
            # Extract title, start date, end date, and company using regular expressions
            import re
            # Example regular expressions to extract title, start date, end date, and company
            title_match = re.search(r'Title:\s*(.*)', text)
            start_date_match = re.search(r'Start Date:\s*(.*)', text)
            end_date_match = re.search(r'End Date:\s*(.*)', text)
            company_match = re.search(r'Company:\s*(.*)', text)
            # Check if matches are found
            if title_match and start_date_match and end_date_match and company_match:
                title = title_match.group(1)
                start_date = start_date_match.group(1)
                end_date = end_date_match.group(1)
                company = company_match.group(1)
                # Store experience details in the database
                conn, cursor = create_connection()
                insert_experience(cursor, title, start_date, end_date, company)
                conn.commit()
                cursor.close()
                conn.close()
                os.remove(filepath)  # Remove the uploaded file after extraction
                return 'PDF uploaded, experience details extracted, and stored in the database successfully!'
        
    return 'No PDF uploaded'

if __name__ == '__main__':
    app.run(debug=True)
